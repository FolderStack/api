service: folderstack

frameworkVersion: '3'
useDotenv: true

package:
    individually: false
    excludeDevDependencies: true
    exclude:
        - 'node_modules/**'

plugins:
    - serverless-domain-manager
    - serverless-prune-plugin
    - serverless-esbuild
    - serverless-dynamodb-local
    - serverless-offline

custom:
    prune:
        automatic: true
        number: 1
    serviceName: api
    currentStage: ${opt:stage, 'local'}
    logLevels:  
        production: warn
        staging: warn
        local: debug
    logLevel: ${self:custom.logLevels.${self:custom.currentStage}, 'info'}
    domains:
        production: "api.folderstack.io"
        staging: "staging-api.folderstack.io"
        local: "localhost"
    customDomain:
        domainName: ${self:custom.domains.${self:custom.currentStage}}
        basePath: "api/v1"
        stage: ${self:custom.currentStage}
        certificateName: "*.folderstack.io"
        createRoute53Record: true
    esbuild:
        bundle: true
        minify: true
        target: node16
        packager: yarn
        sourcemap: false
        sourcesContent: false
        external: ['aws-sdk']
    serverless-offline:
        httpPort: 4000
        lambdaPort: 4001
    dynamodb:
        stages:
            - None
        start:
            migrate: true
            inMemory: true
            docker: true
            seed: true
        seed:
            testSeeds:
                sources:
                    - table: folderstack-local
                      sources: [./test.seed.json]
    serverless-offline-sqs:
        autoCreate: true
        apiVersion: '2012-11-05'
        endpoint: http://0.0.0.0:9324
        region: ap-southeast-2
        accessKeyId: root
        secretAccessKey: root
        skipCacheInvalidation: false
    layers:
        - arn:aws:lambda:${self:provider.region}:943013980633:layer:SentryNodeServerlessSDK:26
    table:
        local: "folderstack-staging"
        staging: "folderstack-staging"
        production: "folderstack-production"
    bucket: "folderstack-assets-${self:custom.currentStage}"

provider:
    name: aws
    runtime: nodejs16.x
    region: ap-southeast-2
    memorySize: 128
    environment:
        ENV: ${self:custom.currentStage}
        LOG_LEVEL: ${self:custom.logLevel, 'info'}
        TABLE_NAME: ${self:custom.table.${self:custom.currentStage}}
        BUCKET_NAME: ${self:custom.bucket}
        AWS_NODEJS_CONNECTION_REUSE_ENABLED: '0'
    iamRoleStatements:
        - Effect: "Allow"
          Action:
            - "s3:GetObject"
            - "s3:PutObject"
          Resource: "arn:aws:s3:::${self:custom.bucket}/*"

resources:
    - ${file(./sls/resources/tables/assets.yaml)}
    - ${file(./sls/outputs.yaml)}

functions:
    - ${file(./src/service-authoriser/sls.yaml)}
    - ${file(./src/service-org/sls.yaml)}
    - ${file(./src/service-assets/sls.yaml)}
    - ${file(./src/service-thumbnails/sls.yaml)}